trigger:
  - development
  - master
  - feature/CA3

pool:
  vmImage: 'ubuntu-latest'  # This will use an Ubuntu-based build agent

jobs:
  - job: Build
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      # Step 1: Checkout Code
      - task: Checkout@1
        displayName: 'Checkout Code'
      
      # Step 2: Install Dependencies
      - script: |
          pip install -r requirements.txt
        displayName: 'Install Dependencies'

      # Step 3: Build Artifact
      - script: |
          zip -r artifact.zip src/
        displayName: 'Build Artifact'

      # Step 4: Upload Artifact
      - task: PublishBuildArtifacts@1
        inputs:
          artifactName: 'build-artifact'
          publishLocation: 'Container'
        displayName: 'Upload Artifact'

  - job: Test
    dependsOn: Build
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      # Step 1: Download Artifact
      - task: DownloadBuildArtifacts@0
        inputs:
          artifactName: 'build-artifact'
          downloadPath: $(Build.ArtifactStagingDirectory)
        displayName: 'Download Artifact'

      # Step 2: Run Unit Tests
      - script: |
          pytest tests/
        displayName: 'Run Unit Tests'

      # Step 3: Static code analysis with Flake8
      - script: |
          pip install flake8
          flake8 .  # Run flake8 on your project directory to check code style issues
        displayName: 'Run Static Code Analysis with Flake8'

      # Step 4: Run Unit Tests with pytest and Track Code Coverage
      - script: |
          pip install pytest
          pip install coverage
          pytest --maxfail=1 --disable-warnings -q --tb=short --junitxml=pytest_results.xml  # Run tests and generate XML results
          coverage run -m pytest  # Run the tests and track code coverage
          coverage xml -o coverage.xml  # Generate the coverage.xml file for Azure DevOps to use
          coverage report  # Print coverage results to the console
        displayName: 'Run Unit Tests with pytest and Track Code Coverage'

  - job: DeployToTest
    dependsOn: Test
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      # Step 1: Deploy to Test Environment
      - script: |
          echo "Deploying to Test"
        displayName: 'Deploy to Test'

  - job: DeployToProd
    dependsOn: DeployToTest
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      # Step 1: Deploy to Production Environment
      - script: |
          echo "Deploying to Production"
        displayName: 'Deploy to Production'

  - job: PublishResults
    dependsOn: Test
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      # Step 1: Publish code coverage results (for Azure DevOps UI integration)
      - task: PublishCodeCoverageResults@2
        inputs:
          codeCoverageTool: 'Cobertura'  # Use 'Cobertura' for Python-based coverage
          summaryFileLocation: '$(Build.SourcesDirectory)/coverage.xml'
          reportDirectory: '$(Build.ArtifactStagingDirectory)'
        displayName: 'Publish Code Coverage Results'

      # Step 2: Publish test results (for Azure DevOps UI integration)
      - task: PublishTestResults@2
        inputs:
          testResultsFiles: '**/pytest_results.xml'
          testRunTitle: 'Unit Tests Results'
        displayName: 'Publish Unit Test Results'
